
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Spatially Sparse Data Structures &#8212; Taichi 1.8.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=b51e6972"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/basic/sparse';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Kernels and Functions" href="../kernels/kernel_function.html" />
    <link rel="prev" title="Interacting with External Arrays" href="external.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.8.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Taichi 1.8.0 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../autoapi/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../autoapi/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../get-started/hello_world.html">Hello, World!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get-started/accelerate_python.html">Accelerate Python with Taichi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get-started/accelerate_pytorch.html">Accelerate PyTorch with Taichi</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="field.html">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="ndarray.html">Taichi Ndarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="layout.html">Fields (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="offset.html">Coordinate Offsets</a></li>
<li class="toctree-l1"><a class="reference internal" href="external.html">Interacting with External Arrays</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spatially Sparse Data Structures</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Kernels</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../kernels/kernel_function.html">Kernels and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernels/kernel_sync.html">Synchronization between Kernels and Python Scope</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Math</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../math/linear_solver.html">Linear Solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/math_module.html">Math Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/sparse_matrix.html">Sparse Matrix</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Performance Tuning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../performance_tuning/performance.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance_tuning/profiler.html">Profiler</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../advanced/data_oriented_class.html">Data-Oriented Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/dataclass.html">Taichi Dataclass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/meta.html">Metaprogramming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/quant.html">Use quantized data types</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Differentiable</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../differentiable/differentiable_programming.html">Differentiable Programming</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Type System</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../type_system/type.html">Type System</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/global_settings.html">Global Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/language_reference.html">Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/operator.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/simt.html">SIMT Intrinsics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/syntax_sugars.html">Syntax Sugars</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Internals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../internals/compilation.html">Life of a Taichi Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/internal.html">Internal Designs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">glossary</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../glossary/glossary.html">Glossary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">FAQs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../faqs/faq.html">Frequently Asked Questions</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Spatially Sparse Data Structures</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spatially-sparse-data-structures">
<h1>Spatially Sparse Data Structures<a class="headerlink" href="#spatially-sparse-data-structures" title="Link to this heading">#</a></h1>
<div class="note docutils">
<p>Prerequisite: please read the <a class="reference internal" href="field.html"><span class="std std-doc">Fields</span></a>, <a class="reference internal" href="layout.html"><span class="std std-doc">Fields (advanced)</span></a>, and <a class="reference internal" href="../internals/internal.html#data-structure-organization"><span class="std std-ref">SNodes</span></a> first.</p>
</div>
<p><img alt="image" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/sparse_grids_3d.jpg" />
Figure: A 3D fluid simulation that uses both particles and grids. Left to right: particles, 1x1x1 voxels, 4x4x4 blocks, 16x16x16 blocks.</p>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>In large-scale spatial computing, such as physical modelling, graphics, and 3D reconstruction, high-resolution 2D/3D grids are frequently required. However, if we employ dense data structures, these grids tend to consume a significant amount of memory space and processing (see <a class="reference internal" href="field.html"><span class="std std-doc">field</span></a> and <a class="reference internal" href="layout.html"><span class="std std-doc">field advanced</span></a>). While a programmer may allocate large dense grids to store spatial data (particularly physical qualities such as a density or velocity field), they may only be interested in a tiny percentage of this dense grid because the remainder may be empty space (vacuum or air).</p>
<p>To illustrate this idea, the regions of interest in sparse grids shown below may only occupy a small fraction of the whole bounding box.
If we can leverage such “spatial sparsity” and focus computation on the regions we care about,
we will significantly save storage and computing power.</p>
<center>
<p><img alt="BVH" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/bvh.png" /></p>
</center>
<div class="note docutils">
<p>The key to leveraging spatial sparsity is replacing <em>dense</em> grids with <em>sparse</em> grids.</p>
</div>
<p>Sparse data structures are traditionally based on <a class="reference external" href="https://en.wikipedia.org/wiki/Quadtree">Quadtrees</a> (2D) and
<a class="reference external" href="https://en.wikipedia.org/wiki/Octree">Octrees</a> (3D). Given that dereferencing pointers is relatively costly on modern computer architectures, Quadtrees and Octrees are less performance friendly than shallower trees with larger branching factors, such as
<a class="reference external" href="https://www.openvdb.org/">VDB</a> and <a class="reference external" href="http://pages.cs.wisc.edu/~sifakis/papers/SPGrid.pdf">SPGrid</a>.
In Taichi, you can compose data structures similar to VDB and SPGrid with SNodes. The advantages of Taichi spatially sparse data structures include:</p>
<ul class="simple">
<li><p>Access with indices, which just like accessing a dense data structure.</p></li>
<li><p>Automatic parallelization when iterating.</p></li>
<li><p>Automatic memory access optimization.</p></li>
</ul>
<div class="note docutils">
<p><strong>Backend compatibility</strong>: The LLVM-based backends (CPU/CUDA) offer the full functionality for performing computations on spatially sparse data structures.
Using sparse data structures on the Metal backend is now deprecated. The support for Dynamic SNode has been removed in v1.3.0,
and the support for Pointer/Bitmasked SNode will be removed in v1.4.0.</p>
</div>
<div class="note docutils">
<p>Sparse matrices are usually <strong>not</strong> implemented in Taichi via spatially sparse data structures. See <a class="reference internal" href="../math/sparse_matrix.html"><span class="std std-doc">sparse matrix</span></a> instead.</p>
</div>
</section>
<section id="spatially-sparse-data-structures-in-taichi">
<h2>Spatially sparse data structures in Taichi<a class="headerlink" href="#spatially-sparse-data-structures-in-taichi" title="Link to this heading">#</a></h2>
<p>Spatially sparse data structures in Taichi are composed of <code class="docutils literal notranslate"><span class="pre">pointer</span></code>, <code class="docutils literal notranslate"><span class="pre">bitmasked</span></code>, <code class="docutils literal notranslate"><span class="pre">dynamic</span></code>, and <code class="docutils literal notranslate"><span class="pre">dense</span></code> SNodes. A SNode tree merely composed of <code class="docutils literal notranslate"><span class="pre">dense</span></code> SNodes is <strong>not</strong> a spatially sparse data structure.</p>
<p>On a spatially sparse data structure, we consider a pixel, a voxel, or a grid node to be <em>active</em> if it is allocated and involved in the computation.
The rest of the grid simply becomes <em>inactive</em>.
In SNode terms, the <em>activity</em> of a leaf or intermediate cell is represented as a Boolean value. The activity value of a cell is <code class="docutils literal notranslate"><span class="pre">True</span></code> if and only if the cell is <em>active</em>. When writing to an inactive cell, Taichi automatically activates it. Taichi also provides manual manipulation of the activity of a cell: See <a class="reference internal" href="#explicitly-manipulating-and-querying-sparsity">Explicitly manipulating and querying sparsity</a>.</p>
<div class="note docutils">
<p>Reading an inactive pixel returns zero.</p>
</div>
<section id="pointer-snode">
<h3>Pointer SNode<a class="headerlink" href="#pointer-snode" title="Link to this heading">#</a></h3>
<p>The code snippet below creates an 8x8 sparse grid, with the top-level being a 4x4 pointer array (line 2 of <code class="docutils literal notranslate"><span class="pre">pointer.py</span></code>),
and each pointer pointing to a 2x2 dense block.
Just as you do with a dense field, you can use indices to write and read the sparse field. The following figure shows the active blocks and pixels in green.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">)</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">pixel</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">pixel</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">():</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">print_active</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Active block&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="c1"># output: Active block 1 1</span>
    <span class="c1">#         Active block 1 2</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;field x[</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">] = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
    <span class="c1"># output: field x[2, 2] = 0.000000</span>
    <span class="c1">#         field x[2, 3] = 1.000000</span>
    <span class="c1">#         field x[3, 2] = 0.000000</span>
    <span class="c1">#         field x[3, 3] = 0.000000</span>
    <span class="c1">#         field x[2, 4] = 2.000000</span>
    <span class="c1">#         field x[2, 5] = 0.000000</span>
    <span class="c1">#         field x[3, 4] = 0.000000</span>
    <span class="c1">#         field x[3, 5] = 0.000000</span>
</pre></div>
</div>
<center>
<p><img alt="Pointer" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/pointer.png" /></p>
</center>
<p>Executing the <code class="docutils literal notranslate"><span class="pre">activate()</span></code> function automatically activates <code class="docutils literal notranslate"><span class="pre">block[1,1]</span></code>, which includes <code class="docutils literal notranslate"><span class="pre">x[2,3]</span></code>, and <code class="docutils literal notranslate"><span class="pre">block[1,2]</span></code>, which includes <code class="docutils literal notranslate"><span class="pre">x[2,4]</span></code>. Other pixels of <code class="docutils literal notranslate"><span class="pre">block[1,1]</span></code> (<code class="docutils literal notranslate"><span class="pre">x[2,2],</span> <span class="pre">x[3,2],</span> <span class="pre">x[3,3]</span></code>) and <code class="docutils literal notranslate"><span class="pre">block[1,2]</span></code> (<code class="docutils literal notranslate"><span class="pre">x[2,5],</span> <span class="pre">x[3,4],</span> <span class="pre">x[3,5]</span></code>) are also implicitly activated because all pixels in the dense block share the same activity value.</p>
<p>In fact, the sparse field is an SNode tree shown in the following figure. You can use a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop to loop over the different levels of the SNode tree like the <code class="docutils literal notranslate"><span class="pre">print_active()</span></code> function in the previous example. A parallelized loop over a block <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i,</span> <span class="pre">j</span> <span class="pre">in</span> <span class="pre">block</span></code> would loop over all active <code class="docutils literal notranslate"><span class="pre">pointer</span></code> SNodes. A parallelized loop over a pixel <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i,</span> <span class="pre">j</span> <span class="pre">in</span> <span class="pre">pixel</span></code> would loop over all active <code class="docutils literal notranslate"><span class="pre">dense</span></code> SNodes.</p>
<center>
<p><img alt="Pointer SNode Tree" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/pointer_tree.png" /></p>
</center>
</section>
<section id="bitmasked-snode">
<h3>Bitmasked SNode<a class="headerlink" href="#bitmasked-snode" title="Link to this heading">#</a></h3>
<p>While a null pointer can effectively represent an empty sub-tree, using 64 bits to represent the activity
of a single pixel at the leaf level can consume too much space.</p>
<p>For example, if each pixel contains a single <code class="docutils literal notranslate"><span class="pre">f32</span></code> value (4 bytes),
the 64-bit pointer pointing to the value would take 8 bytes.
The fact that storage costs of pointers are higher than the space to store the value themselves
goes against our goal to use spatially sparse data structures to save space.</p>
<p>To amortize the storage cost of pointers, you could organize pixels in a <em>blocked</em> manner
and let the pointers directly point to the blocks like the data structure defined in <code class="docutils literal notranslate"><span class="pre">pointer.py</span></code>.</p>
<p>One caveat of this design is that pixels in the same <code class="docutils literal notranslate"><span class="pre">dense</span></code> block can no longer change their activity flexibly.
Instead, they share a single activity flag. To address this issue,
the <code class="docutils literal notranslate"><span class="pre">bitmasked</span></code> SNode additionally allocates 1-bit per pixel data to represent the pixel activity.</p>
<p>The code snippet below illustrates this idea using a 8x8 grid. The only difference between <code class="docutils literal notranslate"><span class="pre">bitmasked.py</span></code> and <code class="docutils literal notranslate"><span class="pre">pointer.py</span></code> is that the bitmasked SNode replaces the dense SNode (line 3).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">)</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">pixel</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">bitmasked</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">pixel</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">():</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">print_active</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Active block&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;field x[</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">] = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
</pre></div>
</div>
<p>Furthermore, the active blocks are the same as <code class="docutils literal notranslate"><span class="pre">pointer.py</span></code> as shown below. However, the bitmasked pixels in the block are not all activated, because each of them has an activity value.</p>
<center>
<p><img alt="Bitmasked" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/bitmasked.png" /></p>
</center>
<p>The bitmasked SNodes are like dense SNodes with auxiliary activity values.</p>
<center>
<p><img alt="Bitmasked SNode Tree" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/bitmasked_tree.png" /></p>
</center>
</section>
<section id="dynamic-snode">
<h3>Dynamic SNode<a class="headerlink" href="#dynamic-snode" title="Link to this heading">#</a></h3>
<p>Taichi officially supports dynamic data structure <em>Dynamic SNode</em> since version v1.4.0. You can think of a dynamic SNode as a <code class="docutils literal notranslate"><span class="pre">List</span></code> that can only store data of a fixed type. The element types it supports include scalars, vectors/matrices, and structs. It also supports the following three APIs:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">append</span></code>: Dynamically adds an element, equivalent to the <code class="docutils literal notranslate"><span class="pre">append</span></code> method of a Python list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deactivate</span></code>: Clears all stored elements, equivalent to the <code class="docutils literal notranslate"><span class="pre">clear</span></code> method of a Python list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">length</span></code>: Gets the actual number of elements currently stored, equivalent to the <code class="docutils literal notranslate"><span class="pre">__len__</span></code> method of a Python list.</p></li>
</ol>
<p>All three methods must be called inside the Taichi scope.</p>
<p>Unfortunately, Dynamic SNode does not support dynamically deleting elements like <code class="docutils literal notranslate"><span class="pre">pop</span></code> and <code class="docutils literal notranslate"><span class="pre">remove</span></code>. This is because it is difficult to implement these operations with high performance in parallel computing.</p>
<div class="note docutils">
<p>Here are a few rules you must obey when using Dynamic Snode:</p>
<ul class="simple">
<li><p>Dynamic SNode can only be used in the CPU and CUDA backends.</p></li>
<li><p>A dynamic SNode must have one axis only, and the axis must be the last axis.</p></li>
<li><p>No other SNodes can be placed under a dynamic SNode. In other words, a dynamic SNode must be directly placed with a field.</p></li>
<li><p>Along the path from a dynamic SNode to the root of the SNode tree, other SNodes <em>must not</em> have the same axis as the dynamic SNode.</p></li>
</ul>
</div>
<p>For example, to declare a one-dimensional dynamic list <code class="docutils literal notranslate"><span class="pre">x</span></code> that stores integers, we can write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">S</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s explain the meaning of these three lines of code:</p>
<ol class="arabic simple">
<li><p>In the first line of code, <code class="docutils literal notranslate"><span class="pre">ti.root.dynamic</span></code> means that the direct parent node of <code class="docutils literal notranslate"><span class="pre">S</span></code> is <code class="docutils literal notranslate"><span class="pre">ti.root</span></code>. Generally, calling <code class="docutils literal notranslate"><span class="pre">S</span> <span class="pre">=</span> <span class="pre">P.dynamic()</span></code> for an SNode <code class="docutils literal notranslate"><span class="pre">P</span></code> means the direct parent node of <code class="docutils literal notranslate"><span class="pre">S</span></code> in the Snode tree is <code class="docutils literal notranslate"><span class="pre">P</span></code>. Hence this operation specifies the position of <code class="docutils literal notranslate"><span class="pre">S</span></code> in the SNode tree system.</p></li>
<li><p>The first parameter of the <code class="docutils literal notranslate"><span class="pre">dynamic</span></code> function is the axis on which <code class="docutils literal notranslate"><span class="pre">S</span></code> is located. This axis must be one-dimensional and cannot have been used by any parent node of <code class="docutils literal notranslate"><span class="pre">S</span></code>. Here we use the axis <code class="docutils literal notranslate"><span class="pre">ti.i</span></code> (equivalent to <code class="docutils literal notranslate"><span class="pre">axis=0</span></code> in NumPy).</p></li>
<li><p>The second parameter of the dynamic function is the maximum length of <code class="docutils literal notranslate"><span class="pre">S</span></code>. Since Dynamic SNode dynamically allocates memory as needed, it does not occupy space when there is no data. However, this maximum length also has an upper limit (the maximum value of 32-bit int type), so it is not possible to assign an astronomical number to it at will. It is also possible to add elements beyond this maximum length, and elements outside the range can also be accessed normally using subscripts, but we recommend keeping the size of the list within the maximum length range.</p></li>
<li><p>The third parameter <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> will be explained later in this article.</p></li>
<li><p>After obtaining the Dynamic SNode <code class="docutils literal notranslate"><span class="pre">S</span></code> in this way, we declare an integer field variable <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">ti.field(int)</span></code>, and then call <code class="docutils literal notranslate"><span class="pre">S.place(x)</span></code> to convert <code class="docutils literal notranslate"><span class="pre">x</span></code> into a data structure described by <code class="docutils literal notranslate"><span class="pre">S</span></code>. Before calling <code class="docutils literal notranslate"><span class="pre">place</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code> cannot be used to store data; after calling <code class="docutils literal notranslate"><span class="pre">place</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code> can be used as a mutable list of type <code class="docutils literal notranslate"><span class="pre">int</span></code>.</p></li>
</ol>
<p>For example, we can use the <code class="docutils literal notranslate"><span class="pre">append</span></code> method to add data to <code class="docutils literal notranslate"><span class="pre">x</span></code>, and call the <code class="docutils literal notranslate"><span class="pre">length</span></code> function to get the actual length of <code class="docutils literal notranslate"><span class="pre">x</span></code>. Both functions must be called inside the kernel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_data</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>

<span class="n">add_data</span><span class="p">()</span>
</pre></div>
</div>
<p>We can also call the <code class="docutils literal notranslate"><span class="pre">deactivate</span></code> method of <code class="docutils literal notranslate"><span class="pre">x</span></code> to clear the entire list, which is equivalent to restoring <code class="docutils literal notranslate"><span class="pre">x</span></code> to its uninitialized state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_data</span><span class="p">():</span>
    <span class="n">x</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>  <span class="c1"># will print 0</span>
</pre></div>
</div>
<p>Returning to the explanation of the <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> parameter: the implementation of Dynamic SNode internally uses linked lists, where multiple elements are densely packed into a node (or “chunk”) of the linked list, with each chunk containing <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> elements. Element allocation and deallocation are performed in units of chunks. The following diagram illustrates how <code class="docutils literal notranslate"><span class="pre">x</span></code> is laid out in memory (with <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">32</span></code>):</p>
<p><img alt="" src="https://github.com/taichi-dev/public_files/blob/master/taichi/doc/dynamic_snode_1d.png?raw=true" /></p>
<p>Thus, the actual number of chunks allocated is <code class="docutils literal notranslate"><span class="pre">ceil(x.length()</span> <span class="pre">/</span> <span class="pre">chunk_size)</span></code>.</p>
<p>We can also define more complex variable-length lists. For example, the following code defines an array <code class="docutils literal notranslate"><span class="pre">x</span></code> of length <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">10</span></code>, where each element of <code class="docutils literal notranslate"><span class="pre">x</span></code> is a one-dimensional variable-length list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">S</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">ti.root.dense(ti.i,</span> <span class="pre">10)</span></code> is a Dense SNode that represents a dense array of length 10 along the <code class="docutils literal notranslate"><span class="pre">ti.i</span></code> axis. <code class="docutils literal notranslate"><span class="pre">S</span> <span class="pre">=</span> <span class="pre">ti.root.dense(ti.i,</span> <span class="pre">10).dynamic(ti.j,</span> <span class="pre">...)</span></code> represents a child node of this Dense SNode, occupying the <code class="docutils literal notranslate"><span class="pre">ti.j</span></code> axis (which is different from the parent node!). The layout of <code class="docutils literal notranslate"><span class="pre">x</span></code> in memory is illustrated in the following diagram:</p>
<p><img alt="" src="https://github.com/taichi-dev/public_files/blob/master/taichi/doc/dynamic_snode_2d.png?raw=true" /></p>
<p>As with the one-dimensional case, you can dynamically add elements to the i-th list using <code class="docutils literal notranslate"><span class="pre">x[i].append()</span></code>, get the current length of the i-th list using <code class="docutils literal notranslate"><span class="pre">x[i].length()</span></code>, and clear the ith list using <code class="docutils literal notranslate"><span class="pre">x[i].deactivate()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_data</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>  <span class="c1"># will print i</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>  <span class="c1"># will print 0</span>
</pre></div>
</div>
<p>All of the above discussion applies to using Dynamic SNode with other numeric types. For vector/matrix and struct types, the steps are identical. For example, consider the following code using struct types:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">SphereType</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">SphereType</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
<span class="n">S</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">x</span></code> is a one-dimensional variable-length list that can store values of type <code class="docutils literal notranslate"><span class="pre">SphereType</span></code>.</p>
</section>
</section>
<section id="computation-on-spatially-sparse-data-structures">
<h2>Computation on spatially sparse data structures<a class="headerlink" href="#computation-on-spatially-sparse-data-structures" title="Link to this heading">#</a></h2>
<section id="sparse-struct-fors">
<h3>Sparse struct-fors<a class="headerlink" href="#sparse-struct-fors" title="Link to this heading">#</a></h3>
<p>Efficiently looping over sparse grid cells that distribute irregularly can be challenging, especially on parallel devices such as GPUs.
In Taichi, <code class="docutils literal notranslate"><span class="pre">for</span></code> loops natively support spatially sparse data structures and only loop over currently active pixels with automatic efficient parallelization.</p>
</section>
<section id="explicitly-manipulating-and-querying-sparsity">
<h3>Explicitly manipulating and querying sparsity<a class="headerlink" href="#explicitly-manipulating-and-querying-sparsity" title="Link to this heading">#</a></h3>
<p>Taichi also provides APIs that explicitly manipulate data structure sparsity. You can manually <strong>check</strong> the activity of a SNode, <strong>activate</strong> a SNode, or <strong>deactivate</strong> a SNode. We now illustrate these functions based on the field defined below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">)</span>
<span class="n">block1</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">block2</span> <span class="o">=</span> <span class="n">block1</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">pixel</span> <span class="o">=</span> <span class="n">block2</span><span class="o">.</span><span class="n">bitmasked</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ij</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">pixel</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<section id="activity-checking">
<h4>1. Activity checking<a class="headerlink" href="#activity-checking" title="Link to this heading">#</a></h4>
<p>You can use <code class="docutils literal notranslate"><span class="pre">ti.is_active(snode,</span> <span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">...])</span></code> to explicitly query if <code class="docutils literal notranslate"><span class="pre">snode[i,</span> <span class="pre">j,</span> <span class="pre">...]</span></code> is active or not.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activity_checking</span><span class="p">(</span><span class="n">snode</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">i</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">snode</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">activity_checking</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">activity_checking</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">activity_checking</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="activation">
<h4>2. Activation<a class="headerlink" href="#activation" title="Link to this heading">#</a></h4>
<p>You can use <code class="docutils literal notranslate"><span class="pre">ti.activate(snode,</span> <span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">...])</span></code> to explicitly activate a cell of <code class="docutils literal notranslate"><span class="pre">snode[i,</span> <span class="pre">j,</span> <span class="pre">...]</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activate_snodes</span><span class="p">():</span>
    <span class="n">ti</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ti</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ti</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">activity_checking</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># output: 1</span>
<span class="n">activity_checking</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># output: 1</span>
<span class="n">activity_checking</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># output: 1</span>
</pre></div>
</div>
<center>
<p><img alt="Activation" src="https://raw.githubusercontent.com/taichi-dev/public_files/master/taichi/doc/activation.png" /></p>
</center>
</section>
<section id="deactivation">
<h4>3. Deactivation<a class="headerlink" href="#deactivation" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">ti.deactivate(snode,</span> <span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">...])</span></code> to explicitly deactivate a cell of <code class="docutils literal notranslate"><span class="pre">snode[i,</span> <span class="pre">j,</span> <span class="pre">...]</span></code>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">snode.deactivate_all()</span></code> to deactivate all cells of SNode <code class="docutils literal notranslate"><span class="pre">snode</span></code>. This operation also recursively deactivates all its children.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">ti.deactivate_all_snodes()</span></code> to deactivate all cells of all SNodes with sparsity.</p></li>
</ul>
<p>When deactivation happens, the Taichi runtime automatically recycles and zero-fills memory of the deactivated containers.</p>
<div class="note docutils">
<p>For performance reasons, <code class="docutils literal notranslate"><span class="pre">ti.activate(snode,</span> <span class="pre">index)</span></code> only activates <code class="docutils literal notranslate"><span class="pre">snode[index]</span></code>.
The programmer must ensure that all ancestor containers of <code class="docutils literal notranslate"><span class="pre">snode[index]</span></code> is already active.
Otherwise, this operation results in undefined behavior.</p>
<p>Similarly, <code class="docutils literal notranslate"><span class="pre">ti.deactivate</span></code> …</p>
<ul class="simple">
<li><p>does <strong>not</strong> recursively deactivate all the descendants of a cell.</p></li>
<li><p>does <strong>not</strong> trigger deactivation of its parent container, even if all the children of the parent container are deactivated.</p></li>
</ul>
</div>
</section>
<section id="ancestor-index-query">
<h4>4. Ancestor index query<a class="headerlink" href="#ancestor-index-query" title="Link to this heading">#</a></h4>
<p>You can use <code class="docutils literal notranslate"><span class="pre">ti.rescale_index(descendant_snode/field,</span> <span class="pre">ancestor_snode,</span> <span class="pre">index)</span></code> to compute the ancestor index given a descendant index.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">rescale_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">])))</span> <span class="c1"># output: [1, 0]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">rescale_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>            <span class="c1"># output: [3, 1]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">rescale_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span>  <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>            <span class="c1"># output: [7, 3]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">rescale_index</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>       <span class="c1"># output: [1, 0]</span>
</pre></div>
</div>
<p>Regarding line 1, you can also compute the <code class="docutils literal notranslate"><span class="pre">block1</span></code> index given <code class="docutils literal notranslate"><span class="pre">pixel</span></code> index <code class="docutils literal notranslate"><span class="pre">[7,</span> <span class="pre">3]</span></code> as <code class="docutils literal notranslate"><span class="pre">[7//2//2,</span> <span class="pre">3//2//2]</span></code>. However, doing so couples computation code with the internal configuration of data structures (in this case, the size of <code class="docutils literal notranslate"><span class="pre">block1</span></code> containers). By using <code class="docutils literal notranslate"><span class="pre">ti.rescale_index()</span></code>, you can avoid hard-coding internal information of data structures.</p>
</section>
</section>
</section>
<section id="sparse-grid">
<h2>Sparse grid<a class="headerlink" href="#sparse-grid" title="Link to this heading">#</a></h2>
<p>We now show an example of how to create a sparse grid with our simplified API(<code class="docutils literal notranslate"><span class="pre">ti.sparse.grid()</span></code>), and how to print the usage with <code class="docutils literal notranslate"><span class="pre">ti.sparse.usage()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">taichi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ti</span>
<span class="c1"># create a 2D sparse grid</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">vec2</span><span class="p">,</span>
        <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">,</span>
        <span class="s2">&quot;grid2particles&quot;</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># access</span>
<span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">vec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid2particles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>

<span class="c1"># print the usage of the sparse grid, which is in [0,1]</span>
<span class="n">ti</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">usage</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
</pre></div>
</div>
<p>possible output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Grid</span> <span class="n">usage</span><span class="p">:</span>  <span class="mf">0.010000</span>
</pre></div>
</div>
</section>
<section id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Link to this heading">#</a></h2>
<p>Please read the SIGGRAPH Asia 2019 <a class="reference external" href="https://yuanming.taichi.graphics/publication/2019-taichi/taichi-lang.pdf">paper</a> or watch the associated
<a class="reference external" href="https://www.youtube.com/watch?v=wKw8LMF3Djo">introduction video</a> with <a class="reference external" href="https://yuanming.taichi.graphics/publication/2019-taichi/taichi-lang-slides.pdf">slides</a>
for more details on computation of spatially sparse data structures.</p>
<p><a class="reference external" href="https://github.com/taichi-dev/taichi_elements">Taichi elements</a> implement a high-performance MLS-MPM solver on Taichi sparse grids.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="external.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Interacting with External Arrays</p>
      </div>
    </a>
    <a class="right-next"
       href="../kernels/kernel_function.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Kernels and Functions</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatially-sparse-data-structures-in-taichi">Spatially sparse data structures in Taichi</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pointer-snode">Pointer SNode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bitmasked-snode">Bitmasked SNode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-snode">Dynamic SNode</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computation-on-spatially-sparse-data-structures">Computation on spatially sparse data structures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sparse-struct-fors">Sparse struct-fors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#explicitly-manipulating-and-querying-sparsity">Explicitly manipulating and querying sparsity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activity-checking">1. Activity checking</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activation">2. Activation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deactivation">3. Deactivation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ancestor-index-query">4. Ancestor index query</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sparse-grid">Sparse grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further reading</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/user_guide/basic/sparse.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023 Taichi Graphics Inc; 2025 Genesis AI Inc.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>